{
  "hash": "e12bf64db26b1e405b4c61ee89eff900",
  "result": {
    "markdown": "---\ntitle: Fun with empirical and function-based derivatives in R\ndate: 2018-02-15\ndescription: Use R to do things with derivatives, both with actual functions and with existing empirical data.\nimage: index_files/figure-html/plot-all-empirical-1.png\ncategories: \n  - r\n  - ggplot\n  - dataviz\n  - economics\n---\n\n\n\n\n<span class=\"small\">([See this notebook on GitHub](https://github.com/andrewheiss/derivatives-r-fun))</span>\n\n---\n\n*tl;dr*: Use functions like `Deriv::Deriv()`, `splinefun()`, `approxfun()`, and `uniroot()` to do things with derivatives in R, both with actual functions and with existing empirical data\n\n---\n\nA typical microeconomics problem involves finding the optimal price and quantity of a product, given its demand and cost across different quantities. You can optimize this price and quantity and maximize profit by finding the point where the marginal cost and the marginal revenue (or the first derivatives of the cost and revenue functions) are equal to each other.\n\nFor instance, the demand for some product can be defined as $Q = 10 - 2P$ (where $Q =$ quantity and $P =$ price). The revenue you get from selling that product is defined as $R = PQ$ (just multiplying price Ã— quantity), so through some algebraic trickery and rearranging of Ps and Qs, you can create a revenue function for this demand curve: $R = 5Q - 0.5Q^2$. The cost function for this product can be defined as $C = 0.25Q + 0.5Q^2$.\n\nTo figure out the optimal profit, we set the marginal cost and marginal revenue equations equal to each other and solve for Q. Here, $\\frac{dC}{dQ} = MC = 0.25 + 0.5Q$ and $\\frac{dR}{dQ} = MR = 5 - Q$, so with algebra we can find the optimal point:\n\n$$\n\\begin{aligned}\nMC &= MR \\\\\n0.25 + 0.5Q &= 5 - Q \\\\\n1.5Q &= 4.75 \\\\\nQ &= 3.1\\overline{66}\n\\end{aligned}\n$$\n\nPhew. Calculus.\n\nDoing this in R is fairly straightforward and far more flexible and far less algebra-intensive. First, define the functions:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(Deriv)\nlibrary(pander)\n\ndemand <- function(q) 5 - (0.5 * q)\nrevenue <- function(q) (5 - 0.5 * q) * q\n\ncost <- function(q) (0.25 * q) + (0.5 * q)^2\n```\n:::\n\n\nPlotting these functions is easy with `geom_function()`: \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = tibble(x = 0:10), aes(x = x)) +\n  geom_function(fun = cost, linewidth = 1, aes(color = \"Total cost\")) +\n  geom_function(fun = revenue, linewidth = 1, aes(color = \"Total revenue\")) +\n  labs(x = \"Quantity\", y = \"Price\") +\n  scale_y_continuous(labels = scales::dollar) +\n  scale_color_manual(values = c(\"Total cost\" = \"red\", \"Total revenue\" = \"blue\"),\n                     name = \"Function\") +\n  theme_light() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-functions-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nThen, using `Deriv::Deriv()`, create derivative functions for the marginal cost and marginal revenue equations:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmr <- Deriv(revenue, \"q\")\nmc <- Deriv(cost, \"q\")\n```\n:::\n\n\nWe can also plot these:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = tibble(x = 0:10), aes(x = x)) +\n  geom_function(fun = mc, linewidth = 1, aes(color = \"Marginal cost\")) +\n  geom_function(fun = mr, linewidth = 1, aes(color = \"Marginal revenue\")) +\n  labs(x = \"Quantity\", y = \"Price\") +\n  scale_y_continuous(labels = scales::dollar) +\n  scale_color_manual(values = c(\"Marginal cost\" = \"red\", \"Marginal revenue\" = \"blue\"),\n                     name = \"Function\") +\n  coord_cartesian(ylim = c(0, 6)) +\n  theme_light() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-marginal-functions-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nFinally, use the `uniroot()` function to look for the point where `mc` and `mr` intersect within a given range (here I'm looking between 1 and 10 since the demand curve goes negative after $Q =$ 10):\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\noptimal_q <- uniroot(function(x) mc(x) - mr(x), c(1, 10))\noptimal_q$root\n## [1] 3.166667\n```\n:::\n\n\nIt's the same answer!\n\nWe can then plug `optimal_q$root` back into the marginal revenue and demand functions to find the optimal price (in a competitive market, the price should be equal to the marginal revenue, but this happens to be a monopoly, so the actual price is higher, but that's totally unrelated to the topic here):\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmr(optimal_q$root)\n## [1] 1.833333\ndemand(optimal_q$root)\n## [1] 3.416667\n# oh noes monopolies\n```\n:::\n\n\n**However! Wait! Stop!** This is all well and fine if you have precise formulas for demand and cost. But real life is far messier than this. What if you don't know the underlying equations?\n\nOften in economics, you have a set of quantities and prices based on empirical data. Market research and surveys can estimate the demand for a product, and tracking how fixed and variable costs change over time can estimate the costs for a product, but this data is all empirically based and not based in actual formulas.\n\nFor instance, suppose you have this table of prices, quantities, and costs (which is actually really based on the demand and cost functions from earlier):\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncosts_revenues <- tibble(Quantity = seq(0, 10, 1),\n                         Price = demand(Quantity),\n                         `Total Revenue` = revenue(Quantity),\n                         `Total Cost` = cost(Quantity),\n                         Profit = `Total Revenue` - `Total Cost`)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Quantity </th>\n   <th style=\"text-align:left;\"> Price </th>\n   <th style=\"text-align:left;\"> Total Revenue </th>\n   <th style=\"text-align:left;\"> Total Cost </th>\n   <th style=\"text-align:left;\"> Profit </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> $5.00 </td>\n   <td style=\"text-align:left;\"> $0.00 </td>\n   <td style=\"text-align:left;\"> $0.00 </td>\n   <td style=\"text-align:left;\"> $0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> $4.50 </td>\n   <td style=\"text-align:left;\"> $4.50 </td>\n   <td style=\"text-align:left;\"> $0.50 </td>\n   <td style=\"text-align:left;\"> $4.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> $4.00 </td>\n   <td style=\"text-align:left;\"> $8.00 </td>\n   <td style=\"text-align:left;\"> $1.50 </td>\n   <td style=\"text-align:left;\"> $6.50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> $3.50 </td>\n   <td style=\"text-align:left;\"> $10.50 </td>\n   <td style=\"text-align:left;\"> $3.00 </td>\n   <td style=\"text-align:left;\"> $7.50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> $3.00 </td>\n   <td style=\"text-align:left;\"> $12.00 </td>\n   <td style=\"text-align:left;\"> $5.00 </td>\n   <td style=\"text-align:left;\"> $7.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> $2.50 </td>\n   <td style=\"text-align:left;\"> $12.50 </td>\n   <td style=\"text-align:left;\"> $7.50 </td>\n   <td style=\"text-align:left;\"> $5.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> $2.00 </td>\n   <td style=\"text-align:left;\"> $12.00 </td>\n   <td style=\"text-align:left;\"> $10.50 </td>\n   <td style=\"text-align:left;\"> $1.50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> $1.50 </td>\n   <td style=\"text-align:left;\"> $10.50 </td>\n   <td style=\"text-align:left;\"> $14.00 </td>\n   <td style=\"text-align:left;\"> -$3.50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> $1.00 </td>\n   <td style=\"text-align:left;\"> $8.00 </td>\n   <td style=\"text-align:left;\"> $18.00 </td>\n   <td style=\"text-align:left;\"> -$10.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> $0.50 </td>\n   <td style=\"text-align:left;\"> $4.50 </td>\n   <td style=\"text-align:left;\"> $22.50 </td>\n   <td style=\"text-align:left;\"> -$18.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> $0.00 </td>\n   <td style=\"text-align:left;\"> $0.00 </td>\n   <td style=\"text-align:left;\"> $27.50 </td>\n   <td style=\"text-align:left;\"> -$27.50 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nWe can still use R to find the optimal quantity, ***even without actual formulas***. R has two base functions for approximating functions based on existing data. `approxfun()` will try to fit data linearly, and `splinefun()` will try to fit data with cubic splines (i.e. it can handle curvy lines better than `approxfun()`).\n\nFirst, we can plot the revenue and cost columns to see their shape:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncosts_revenues_plot <- costs_revenues %>% \n  select(Quantity, starts_with(\"Total\")) %>% \n  gather(Variable, Price, -Quantity)\n\nggplot(costs_revenues_plot, aes(x = Quantity, y = Price, color = Variable)) +\n  geom_line(linewidth = 1) +\n  scale_y_continuous(labels = scales::dollar) +\n  scale_color_manual(values = c(\"red\", \"blue\")) +\n  theme_light() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/empirical-cost-revenue-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nBecause both variables are curvilinear, it's probably best to approximate their functions using splines with `splinefun()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncost_empirical <- splinefun(x = costs_revenues$Quantity, \n                            y = costs_revenues$`Total Cost`)\n\nrevenue_empirical <- splinefun(x = costs_revenues$Quantity, \n                               y = costs_revenues$`Total Revenue`)\n```\n:::\n\n\nIf we compare the empirically-based functions with their real-life counterparts, we can see that the approximation worked great:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncost(1:10)\n##  [1]  0.5  1.5  3.0  5.0  7.5 10.5 14.0 18.0 22.5 27.5\ncost_empirical(1:10)\n##  [1]  0.5  1.5  3.0  5.0  7.5 10.5 14.0 18.0 22.5 27.5\n\nrevenue(1:10)\n##  [1]  4.5  8.0 10.5 12.0 12.5 12.0 10.5  8.0  4.5  0.0\nrevenue_empirical(1:10)\n##  [1]  4.5  8.0 10.5 12.0 12.5 12.0 10.5  8.0  4.5  0.0\n```\n:::\n\n\nDetermining the marginal cost and revenue functions from these approximations is surprisingly easy because `splinefun()` objects have a built-in mechanism for returning derivatives with a `deriv` argument:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmc(1:10)\n##  [1] 0.75 1.25 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25\ncost_empirical(1:10, deriv = 1)\n##  [1] 0.75 1.25 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25\n\nmr(1:10)\n##  [1]  4  3  2  1  0 -1 -2 -3 -4 -5\nrevenue_empirical(1:10, deriv = 1)\n##  [1]  4  3  2  1  0 -1 -2 -3 -4 -5\n```\n:::\n\n\nMagic!\n\nWe can plot these empirically-approximated marginal functions and see that they intersect, as expected:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = tibble(x = 0:10), aes(x = x)) +\n  geom_function(fun = cost_empirical, linewidth = 1, args = list(deriv = 1),\n                aes(color = \"Marginal cost\")) +\n  geom_function(fun = revenue_empirical, linewidth = 1, args = list(deriv = 1),\n                aes(color = \"Marginal revenue\")) +\n  labs(x = \"Quantity\", y = \"Price\") +\n  scale_y_continuous(labels = scales::dollar) +\n  scale_color_manual(values = c(\"Marginal cost\" = \"red\", \"Marginal revenue\" = \"blue\"),\n                     name = \"Empirical function\") +\n  coord_cartesian(ylim = c(0, 6)) +\n  theme_light() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-empirical-marginal-functions-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nFinally, we can use `uniroot()` to find where these two functions intersect:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\noptimal_q_empirical <- uniroot(function(x) cost_empirical(x, deriv = 1) - \n                                 revenue_empirical(x, deriv = 1), c(1, 10))\noptimal_q_empirical$root\n## [1] 3.166667\n```\n:::\n\n\nIt's the same!\n\nAnd just like before, we can find the optimal price, given this quantity. But first we have to create an empirical function for the demand. The demand variable is linear here, so we can use `approxfun()`, but `splinefun()` works just fine too (and it has built-in derivative capabilities, while `approxfun()` doesn't).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nrevenue_empirical(optimal_q_empirical$root, deriv = 1)\n## [1] 1.833333\n\ndemand_empricial_spline <- splinefun(x = costs_revenues$Quantity,\n                                     y = costs_revenues$Price)\n\ndemand_empricial_approx <- approxfun(x = costs_revenues$Quantity,\n                                     y = costs_revenues$Price)\n\ndemand_empricial_spline(optimal_q_empirical$root)\n## [1] 3.416667\ndemand_empricial_approx(optimal_q_empirical$root)\n## [1] 3.416667\n# oh noes monopolies again\n```\n:::\n\n\nWe can plot all of these things together:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = tibble(x = 0:10), aes(x = x)) +\n  geom_function(fun = demand_empricial_spline, linewidth = 1,\n                aes(color = \"Demand\")) +\n  geom_function(fun = cost_empirical, linewidth = 1, args = list(deriv = 1),\n                aes(color = \"Marginal cost\")) +\n  geom_function(fun = revenue_empirical, linewidth = 1, args = list(deriv = 1),\n                aes(color = \"Marginal revenue\")) +\n  geom_vline(xintercept = optimal_q_empirical$root, \n             color = \"grey50\", linetype = \"dashed\") +\n  geom_hline(yintercept = revenue_empirical(optimal_q_empirical$root, deriv = 1), \n             color = \"grey50\", linetype = \"dashed\") +\n  labs(x = \"Quantity\", y = \"Price\") +\n  scale_y_continuous(labels = scales::dollar) +\n  scale_color_manual(values = c(\"Marginal cost\" = \"red\", \"Marginal revenue\" = \"blue\",\n                                \"Demand\" = \"darkgreen\"),\n                     name = \"Function\") +\n  coord_cartesian(ylim = c(0, 6)) +\n  theme_light() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-all-empirical-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nIn this case, the empirical solution and the function-based solution are identical, but that's only because I created the empirical data from the functions. In real life, though, this same process should work on any empirical price, quantity, and cost data.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}