{
  "hash": "7c4bf8b6f212cc539ccbc03a5fcbd13c",
  "result": {
    "markdown": "---\ntitle: \"How to make fancy road trip maps with R and OpenStreetMap\"\ndate: 2023-06-01\ndescription: \"Use R to get geocoded location and routing data from OpenStreetMap and explore our family's impending 5,000 mile road trip around the USA\"\nimage: index_files/figure-html/plot-routes-stops-distances-1.png\ntwitter-card:\n  image: \"index_files/figure-html/plot-routes-stops-distances-1.png\"\nopen-graph:\n  image: \"index_files/figure-html/plot-routes-stops-distances-1.png\"\ncategories:\n  - r\n  - tidyverse\n  - ggplot\n  - gis\n  - maps\nformat:\n  html:\n    reference-location: margin\n    code-fold: show\ndoi: 10.59350/rgwda-0tv16\ncitation: true\n---\n\n\n\n\nIn a couple days, I'm going to drive across the country to Utah, my home state. I haven't been out west with my whole family in four years—not since 2019 when we moved from Spanish Fork, Utah to Atlanta, Georgia. According to Google Maps, [it's a mere 1,900 miles](https://goo.gl/maps/aGXJPL85LMTW2cuS9) (3,000 kilometers) through the middle of the United States and should take 28 hours, assuming no stops. \n\n![Google Maps route from Atlanta, Georgia to Spanish Fork, Utah](img/google-maps-ga-to-ut.png)\n\nFor bonus fun though, my wife and I decided to make this trip even more adventurous and hit as many exciting stops as possible. So rather than drive through the middle of Kansas, we're going along the southern border on the way there, visiting New Orleans, Louisiana; San Antonio, Texas; [Carlsbad Caverns](https://en.wikipedia.org/wiki/Carlsbad_Caverns_National_Park), New Mexico; the [Grand Canyon](https://en.wikipedia.org/wiki/Grand_Canyon) in Arizona; and then camping for a couple days at [Capitol Reef National Park](https://en.wikipedia.org/wiki/Capitol_Reef_National_Park) in Southern Utah before finally arriving at my aunt's house in Spanish Fork, Utah. On the way home, we're going across the northern part of the United States, visiting my sister in Idaho before heading towards [Yellowstone](https://en.wikipedia.org/wiki/Yellowstone_National_Park) in Wyoming; [Devil's Tower](https://en.wikipedia.org/wiki/Devils_Tower) in Wyoming; [Mount Rushmore](https://en.wikipedia.org/wiki/Mount_Rushmore) in South Dakota; and [Nauvoo, Illinois](https://en.wikipedia.org/wiki/Nauvoo,_Illinois) ([Mormons!](https://www.churchofjesuschrist.org/learn/locations/historic-nauvoo)). It's going to be an awesome—but *way* longer—mega road trip. \n\nTo help keep six kids entertained beyond just plugging them into iPads, my wife made some road trip journals to make the experience more memorable and educational, and we're bringing a bunch of books and extra materials about each of the stops we'll be making so they can do research along the way.\n\nI just finished revamping my [online data visualization class](https://datavizs23.classes.andrewheiss.com/) this week since the summer semester is starting next week, so visualizing data through maps has been on my mind. In my session on visualizing maps, [I added a section on making and visualizing your own geocoded data](https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data) (i.e. plotting specific cities on a map), so I figured it would be neat to visualize this huge road trip somehow to make some maps to include in the kids' journals.\n\nGetting the latitude and longitude coordinates for specific cities or addresses is super easy—you can either [right click on Google Maps and copy specific coordinates](https://datavizs23.classes.andrewheiss.com/example/12-example.html#making-your-own-geocoded-data), or you can [automate it](https://datavizs23.classes.andrewheiss.com/example/12-example.html#automatic-geoencoding-by-address) with the [{tidygeocoder} package](https://jessecambon.github.io/tidygeocoder/) in R. \n\nGetting route coordinates is a lot trickier though, since it involves all sorts of complex algorithms (accounting for road locations, speed limits, traffic, etc.). This is why Google Maps is so invaluable—it does an excellent job of figuring this out. But Google's data is proprietary. \n\nThere's an R package named [{mapsapi}](https://github.com/michaeldorman/mapsapi) that makes it really easy to get data from the Google Maps API, and if you get an API key from Google ([following these instructions](https://developers.google.com/maps/documentation/directions/start#create-project)), you can extract geocoded {sf}-compatible route data from Google with the `mp_directions()` function. It's neat and quick and easy, but it's expensive. When I first started playing with the maps API in R, I racked up \\$0.50 in charges just with testing a bunch of routing options. The Google Maps API gives you \\$200 in free credits every month and I was well below that amount, but it still was a little nervewracking to see that it was that expensive in just an hour of tinkering. Also, setting up the API key was fairly complicated (creating a Google Cloud project, setting up billing, enabling specific services, storing the API key securely on my computer, etc.), and I don't want to go through that hassle in the future.\n\n![Google Maps API costs](img/google-maps-api-costs.png)\n\nI'm a fan of the [OpenStreetMap project](https://www.openstreetmap.org/), and it's [one of the backends](https://jessecambon.github.io/tidygeocoder/articles/geocoder_services.html) (through [Nominatim](https://nominatim.org/)) for {tidygeocoder} (and I used it in a [previous blog post](https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#in-the-united-states) showing some coordinates in interactive Leaflet maps). In searching around the internet for open source alternatives to the Google Maps API, I discovered that OpenStreetMap can also do directions and routing through the [Open Source Routing Machine (OSRM) project](http://project-osrm.org/). You can use OSRM's [public demo server](https://map.project-osrm.org) for small-scale routing things, or you can [install your own local instance through Docker](https://github.com/Project-OSRM/osrm-backend#using-docker). And super conveniently, there's also an R package called [{osrm}](https://github.com/riatelab/osrm) for accessing the OSRM API. This means that it's possible to pull geocoded routing and directions data into R in an open source (and free!) way.\n\nSo let's see how to use {osrm} and make some neat road trip maps with {sf} and {ggplot2}!\n\n# Getting started\n\n## Who this post is for\n\nHere's what I assume you know:\n\n- You're familiar with [R](https://www.r-project.org/) and the [tidyverse](https://www.tidyverse.org/) (particularly [{dplyr}](https://dplyr.tidyverse.org/) and [{ggplot2}](https://ggplot2.tidyverse.org/)).\n- You're somewhat familiar with [{sf}](https://r-spatial.github.io/sf/) for working with geographic data. I have a [whole tutorial here](https://datavizs23.classes.andrewheiss.com/example/12-example.html) and a [simplified one here](https://www.andrewheiss.com/blog/2023/04/26/middle-earth-mapping-sf-r-gis/#lightning-quick-overview-of-sf-and-shapefiles) and the [{sf} documentation has a ton of helpful vignettes and blog posts](https://r-spatial.github.io/sf/), and there are also two free books about it: [*Spatial Data Science*](https://r-spatial.org/book/) and [*Geocomputation with R*](https://r.geocompx.org/). Also [check this fantastic post out](https://www.jessesadler.com/post/simple-feature-objects/) to learn more about the anatomy of a `geometry` column with {sf}.\n\n## Packages and functions\n\nBefore officially getting started, let’s load all the packages we need and create some helpful functions and variables:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)     # ggplot, dplyr, and friends\nlibrary(sf)            # Handle spatial data in R in a tidy way\nlibrary(tigris)        # Access geographic data from the US Census\nlibrary(tidygeocoder)  # Automated geocoding\nlibrary(osrm)          # Access OSRM through R\nlibrary(ggrepel)       # Nicer non-overlapping labels\nlibrary(glue)          # Easier string interpolation\nlibrary(scales)        # Nicer labeling functions\nlibrary(patchwork)     # Combine plots nicely\nlibrary(ggspatial)     # Nicer map features like scale bars\n\n# Custom ggplot theme to make pretty plots\n# Get the font at https://fonts.google.com/specimen/Overpass\ntheme_roadtrip <- function() {\n  theme_void(base_family = \"Overpass Light\") +\n    theme(\n      plot.title = element_text(family = \"Overpass\", face = \"bold\", hjust = 0.5),\n      strip.text = element_text(\n        family = \"Overpass ExtraBold\", face = \"plain\",\n        size = rel(1.1), hjust = 0.5)\n    )\n}\n\n# Make labels use Overpass by default\nupdate_geom_defaults(\"label_repel\", \n                     list(family = \"Overpass\",\n                          fontface = \"plain\"))\nupdate_geom_defaults(\"label\", \n                     list(family = \"Overpass\",\n                          fontface = \"plain\"))\n\nupdate_geom_defaults(\"text_repel\", \n                     list(family = \"Overpass\",\n                          fontface = \"plain\"))\nupdate_geom_defaults(\"text\", \n                     list(family = \"Overpass\",\n                          fontface = \"plain\"))\n\n# Yellowstone colors\nclrs <- NatParksPalettes::natparks.pals(\"Yellowstone\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#' Format duration in minutes and hours\n#'\n#' This function takes a numeric input \\code{x} representing a duration in minutes,\n#' rounds it to the nearest 15 minutes, and formats the result as a string\n#' indicating the number of hours and minutes in the duration.\n#'\n#' @param x A numeric input representing a duration in minutes.\n#' @return A character vector of formatted duration strings.\n#' @examples\n#' fmt_duration(c(93, 1007, 3056))\nfmt_duration <- function(x) {\n  # Round to the nearest 15 minutes\n  n_seconds <- round(seconds(x * 60) / (15 * 60)) * (15 * 60)\n  n_seconds <- seconds_to_period(n_seconds)\n  \n  out <- map_chr(n_seconds, \\(n) {\n    if (seconds(n) <= 59) {\n      # If this is less than an hour, don't format anything with hours\n      glue(\"{MM} minutes\", MM = minute(n))\n    } else {\n      # I only want to format this as a number of hours. If the duration is\n      # longer than 24 hours, seconds_to_period() rolls over into days (i.e.\n      # seconds_to_period(60 * 60 * 24) returns \"1d 0H 0M 0S\"), and it shows\n      # zero hours. So we extract the day part of the period, multiply it by 24,\n      # and add it to the hour component that we want to display\n      extra_day_hours <- day(n) * 24\n  \n      glue(\"{HH} hour{s} {MM} minutes\",\n        HH = scales::label_comma()(hour(n) + extra_day_hours),\n        MM = minute(n),\n        s = ifelse(hour(n) == 1, \"\", \"s\")\n      )\n    }\n  })\n  \n  return(out)\n}\n\nfmt_miles <- scales::label_number(accuracy = 10, suffix = \" miles\", big.mark = \",\")\n\nmiles_to_meters <- function(x) {\n  x * 1609.344\n}\n\nmeters_to_miles <- function(x) {\n  x / 1609.344\n}\n\nkm_to_miles <- function(x) {\n  meters_to_miles(x * 1000)\n}\n```\n:::\n\n\n\n# State data\n\nFirst we need state boundaries. We can get these from the US Census with `states()` from {tigris}:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nus_states <- states(resolution = \"20m\", year = 2022, cb = TRUE)\n\nlower_48 <- us_states %>% \n  filter(!(NAME %in% c(\"Alaska\", \"Hawaii\", \"Puerto Rico\")))\n```\n:::\n\n\n\n\nHere's what they look like (using the [Albers projection for the contiguous USA](https://epsg.io/102003)): \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() + \n  geom_sf(data = lower_48) +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![48 contiguous states](index_files/figure-html/plot-states-only-1.png){fig-align='center' fig-alt='48 contiguous states' width=100%}\n:::\n:::\n\n\nSuper quick and easy.\n\n# Stops data\n\nNext we need to geocode and plot all the stops we'll be making on the trip. I'll stick them all in a data frame with columns indicating the direction (with a nod to Bilbo Baggins's [\"There and Back Again\"](https://en.wikipedia.org/wiki/There_and_Back_Again_(disambiguation)) journey with the dwarves in *The Hobbit*) and the day of the leg of the trip:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstops_raw <- tribble(\n  ~direction,   ~day, ~city,\n  \"There\",      1,    \"Atlanta, Georgia\", \n  \"There\",      2,    \"New Orleans, Louisiana\", \n  \"There\",      3,    \"San Antonio, Texas\", \n  \"There\",      4,    \"Carlsbad, New Mexico\", \n  \"There\",      5,    \"Grand Canyon NP, Arizona\",\n  \"There\",      6,    \"Grover, Utah\",  \n  \"Back again\", 1,    \"Spanish Fork, Utah\", \n  \"Back again\", 1,    \"Shelley, Idaho\",  \n  \"Back again\", 2,    \"Yellowstone NP, Wyoming\",\n  \"Back again\", 2,    \"Devil's Tower, Wyoming\",  \n  \"Back again\", 3,    \"Mount Rushmore, South Dakota\", \n  \"Back again\", 4,    \"Albert Lea, Minnesota\", \n  \"Back again\", 5,    \"Nauvoo, Illinois\", \n  \"Back again\", 6,    \"Atlanta, Georgia\"\n)  %>% \n  mutate(direction = fct_inorder(direction))\nstops_raw\n## # A tibble: 14 × 3\n##    direction    day city                        \n##    <fct>      <dbl> <chr>                       \n##  1 There          1 Atlanta, Georgia            \n##  2 There          2 New Orleans, Louisiana      \n##  3 There          3 San Antonio, Texas          \n##  4 There          4 Carlsbad, New Mexico        \n##  5 There          5 Grand Canyon NP, Arizona    \n##  6 There          6 Grover, Utah                \n##  7 Back again     1 Spanish Fork, Utah          \n##  8 Back again     1 Shelley, Idaho              \n##  9 Back again     2 Yellowstone NP, Wyoming     \n## 10 Back again     2 Devil's Tower, Wyoming      \n## 11 Back again     3 Mount Rushmore, South Dakota\n## 12 Back again     4 Albert Lea, Minnesota       \n## 13 Back again     5 Nauvoo, Illinois            \n## 14 Back again     6 Atlanta, Georgia\n```\n:::\n\n\nI could go to Google Maps and right click on each of these places and copy the latitude/longitude coordinates, but that's not very reproducible and involves a lot of clicking around. We can do it programmatically with `geocode()` from {tidygeocoder}, but first we need to help the API a little. With most of these places, OpenStreetMap will return the center of the city (like with Atlanta), and that's fine. With larger places like the Grand Canyon and Yellowstone, though, OpenStreetMap will give coordinates for the middle of the parks, which are literally in the middle of nowhere and will mess up our directions (since it's not really possible to drive to the middle of the whole Grand Canyon). To fix this we'll make a little dataset of some more specific addresses and join it to the list of stops. We'll geocode the more specific address column:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstops_addresses <- tribble(\n  ~city, ~address,\n  \"Grand Canyon NP, Arizona\", \"Grand Canyon Visitor Center, Arizona\",\n  \"Yellowstone NP, Wyoming\", \"Old Faithful, Teton County, Wyoming\",\n)\n\nstops_to_geocode <- stops_raw %>% \n  left_join(stops_addresses, by = join_by(city)) %>% \n  # Combine the address and city columns, with a preference for address\n  mutate(address = coalesce(address, city))\n\nstops_to_geocode\n## # A tibble: 14 × 4\n##    direction    day city                         address                             \n##    <fct>      <dbl> <chr>                        <chr>                               \n##  1 There          1 Atlanta, Georgia             Atlanta, Georgia                    \n##  2 There          2 New Orleans, Louisiana       New Orleans, Louisiana              \n##  3 There          3 San Antonio, Texas           San Antonio, Texas                  \n##  4 There          4 Carlsbad, New Mexico         Carlsbad, New Mexico                \n##  5 There          5 Grand Canyon NP, Arizona     Grand Canyon Visitor Center, Arizona\n##  6 There          6 Grover, Utah                 Grover, Utah                        \n##  7 Back again     1 Spanish Fork, Utah           Spanish Fork, Utah                  \n##  8 Back again     1 Shelley, Idaho               Shelley, Idaho                      \n##  9 Back again     2 Yellowstone NP, Wyoming      Old Faithful, Teton County, Wyoming \n## 10 Back again     2 Devil's Tower, Wyoming       Devil's Tower, Wyoming              \n## 11 Back again     3 Mount Rushmore, South Dakota Mount Rushmore, South Dakota        \n## 12 Back again     4 Albert Lea, Minnesota        Albert Lea, Minnesota               \n## 13 Back again     5 Nauvoo, Illinois             Nauvoo, Illinois                    \n## 14 Back again     6 Atlanta, Georgia             Atlanta, Georgia\n```\n:::\n\n\nTo get the coordinates, we'll feed the address column to `geocode()` and then convert the resulting numeric `long` and `lat` into an official sf geometry column (with the [WGS 84 (−180 to 180) scale](https://en.wikipedia.org/wiki/World_Geodetic_System)):\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstops_geocoded <- stops_to_geocode %>% \n  geocode(address, method = \"osm\") %>%\n  st_as_sf(coords = c(\"long\", \"lat\"), crs = st_crs(\"EPSG:4326\"))\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstops_geocoded\n## Simple feature collection with 14 features and 4 fields\n## Geometry type: POINT\n## Dimension:     XY\n## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6\n## Geodetic CRS:  WGS 84\n## # A tibble: 14 × 5\n##    direction    day city                         address                                  geometry\n##  * <fct>      <dbl> <chr>                        <chr>                                 <POINT [°]>\n##  1 There          1 Atlanta, Georgia             Atlanta, Georgia                     (-84.4 33.7)\n##  2 There          2 New Orleans, Louisiana       New Orleans, Louisiana                 (-90.1 30)\n##  3 There          3 San Antonio, Texas           San Antonio, Texas                   (-98.5 29.4)\n##  4 There          4 Carlsbad, New Mexico         Carlsbad, New Mexico                  (-104 32.4)\n##  5 There          5 Grand Canyon NP, Arizona     Grand Canyon Visitor Center, Arizona  (-112 36.1)\n##  6 There          6 Grover, Utah                 Grover, Utah                          (-111 38.2)\n##  7 Back again     1 Spanish Fork, Utah           Spanish Fork, Utah                    (-112 40.1)\n##  8 Back again     1 Shelley, Idaho               Shelley, Idaho                        (-112 43.4)\n##  9 Back again     2 Yellowstone NP, Wyoming      Old Faithful, Teton County, Wyoming   (-111 44.5)\n## 10 Back again     2 Devil's Tower, Wyoming       Devil's Tower, Wyoming                (-105 44.6)\n## 11 Back again     3 Mount Rushmore, South Dakota Mount Rushmore, South Dakota          (-103 43.9)\n## 12 Back again     4 Albert Lea, Minnesota        Albert Lea, Minnesota                (-93.4 43.6)\n## 13 Back again     5 Nauvoo, Illinois             Nauvoo, Illinois                     (-91.4 40.6)\n## 14 Back again     6 Atlanta, Georgia             Atlanta, Georgia                     (-84.4 33.7)\n```\n:::\n\n\nAtlanta is in there twice, so we'll need to drop the last row so that we don't plot the points and labels for it twice:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nall_stops_unique <- stops_geocoded %>% \n  slice(1:(n() - 1))\n```\n:::\n\n\nAnd let's plot it all:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48) +\n  geom_sf(data = all_stops_unique) +\n  geom_label_repel(\n    data = all_stops_unique,\n    aes(label = city, geometry = geometry),\n    stat = \"sf_coordinates\", seed = 1234,\n    size = 3, segment.color = clrs[3], min.segment.length = 0\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![All the main stops for our road trip](index_files/figure-html/plot-stops-only-1.png){fig-align='center' fig-alt='All the main stops for our road trip' width=100%}\n:::\n:::\n\n\n# Routing\n\nNext we need to figure out the routes between each of these points. The `osrmRoute()` function in {osrm} takes two main arguments: (1) coordinates for the source location (`src`) and (2) coordinates for the destination location (`dst`). To make it easy to work with routing data in a dataframe, we need to manipulate the data a bit so that we get a row per route, with columns for the origin and destination cities.\n\nWe'll create a copy of the geometry column in `stops_geocoded` and shift it forward one row with `lead()` and drop the last row because it doesn't have a destination:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nroutes_raw <- stops_geocoded %>% \n  select(-address) %>% \n  rename(\n    origin_geometry = geometry,\n    origin_city = city\n  ) %>% \n  mutate(\n    destination_geometry = lead(origin_geometry),\n    destination_city = lead(origin_city)\n  ) %>% \n  filter(row_number() != n())\nroutes_raw\n## Simple feature collection with 13 features and 4 fields\n## Active geometry column: origin_geometry\n## Geometry type: POINT\n## Dimension:     XY\n## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6\n## Geodetic CRS:  WGS 84\n## # A tibble: 13 × 6\n##    direction    day origin_city                  origin_geometry destination_geometry destination_city            \n##  * <fct>      <dbl> <chr>                            <POINT [°]>          <POINT [°]> <chr>                       \n##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana      \n##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas          \n##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico        \n##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona    \n##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                \n##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah          \n##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho              \n##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming     \n##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming      \n## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota\n## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota       \n## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois            \n## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia\n```\n:::\n\n\nWith the data like this, we can now feed each row individually to `osrmRoute` and get geocoded paths between each origin and destination:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nroutes_geocoded_raw <- routes_raw %>% \n  rowwise() %>% \n  mutate(route = osrmRoute(\n    src = origin_geometry, \n    dst = destination_geometry)\n  )\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nroutes_geocoded_raw\n## Simple feature collection with 13 features and 5 fields\n## Active geometry column: origin_geometry\n## Geometry type: POINT\n## Dimension:     XY\n## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6\n## Geodetic CRS:  WGS 84\n## # A tibble: 13 × 7\n## # Rowwise: \n##    direction    day origin_city                  origin_geometry destination_geometry destination_city             route$src $dst  $duration $distance                                                                                 $geometry\n##  * <fct>      <dbl> <chr>                            <POINT [°]>          <POINT [°]> <chr>                        <chr>     <chr>     <dbl>     <dbl>                                                                          <LINESTRING [°]>\n##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana       src       dst        513.      753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...\n##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas           src       dst        596.      870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...\n##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico         src       dst        458.      727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...\n##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona     src       dst        749.     1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....\n##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                 src       dst        510.      628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...\n##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah           src       dst        197.      273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....\n##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho               src       dst        262.      411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...\n##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming      src       dst        199.      240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...\n##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming       src       dst        552.      694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....\n## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota src       dst        161.      215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....\n## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota        src       dst        548.      866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...\n## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois             src       dst        359.      487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...\n## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia             src       dst        847.     1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...\n```\n:::\n\n\nThe route details are included in a [nested data frame list column](https://tidyr.tidyverse.org/articles/nest.html) named `route`, so we'll need to unnest it. The resulting data frame now has three different geometry columns (!) for the origin point, destination point, and the route, so we'll set the route column as the data frame's primary geometry column (which makes it so we can just use `geom_sf(data = routes_geocoded)` instead of `geom_sf(data = routes_geocoded, aes(geometry = whatever))`). The route data also includes some helpful details about the distance (in kilometers) and duration (in minutes), so we'll create nicely formatted text-based versions of these too:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nroutes_geocoded <- routes_geocoded_raw %>% \n  unnest(route, names_sep = \"_\") %>% \n  st_set_geometry(\"route_geometry\") %>% \n  mutate(\n    distance_miles = km_to_miles(route_distance),\n    distance_text = fmt_miles(distance_miles),\n    duration_text = fmt_duration(route_duration)\n  )\nroutes_geocoded\n## Simple feature collection with 13 features and 11 fields\n## Active geometry column: route_geometry\n## Geometry type: LINESTRING\n## Dimension:     XY\n## Bounding box:  xmin: -113 ymin: 29.4 xmax: -84.4 ymax: 44.9\n## Geodetic CRS:  WGS 84\n## # A tibble: 13 × 14\n##    direction    day origin_city                  origin_geometry destination_geometry destination_city             route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text   \n##  * <fct>      <dbl> <chr>                            <POINT [°]>          <POINT [°]> <chr>                        <chr>     <chr>              <dbl>          <dbl>                                                                          <LINESTRING [°]>          <dbl> <chr>         <chr>           \n##  1 There          1 Atlanta, Georgia                (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana       src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minu…\n##  2 There          2 New Orleans, Louisiana            (-90.1 30)         (-98.5 29.4) San Antonio, Texas           src       dst                 596.           870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...           541. 540 miles     10 hours 0 minu…\n##  3 There          3 San Antonio, Texas              (-98.5 29.4)          (-104 32.4) Carlsbad, New Mexico         src       dst                 458.           727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...           452. 450 miles     7 hours 45 minu…\n##  4 There          4 Carlsbad, New Mexico             (-104 32.4)          (-112 36.1) Grand Canyon NP, Arizona     src       dst                 749.          1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....           684. 680 miles     12 hours 30 min…\n##  5 There          5 Grand Canyon NP, Arizona         (-112 36.1)          (-111 38.2) Grover, Utah                 src       dst                 510.           628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...           390. 390 miles     8 hours 30 minu…\n##  6 There          6 Grover, Utah                     (-111 38.2)          (-112 40.1) Spanish Fork, Utah           src       dst                 197.           273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....           169. 170 miles     3 hours 15 minu…\n##  7 Back again     1 Spanish Fork, Utah               (-112 40.1)          (-112 43.4) Shelley, Idaho               src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minu…\n##  8 Back again     1 Shelley, Idaho                   (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming      src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minu…\n##  9 Back again     2 Yellowstone NP, Wyoming          (-111 44.5)          (-105 44.6) Devil's Tower, Wyoming       src       dst                 552.           694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....           431. 430 miles     9 hours 15 minu…\n## 10 Back again     2 Devil's Tower, Wyoming           (-105 44.6)          (-103 43.9) Mount Rushmore, South Dakota src       dst                 161.           215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....           133. 130 miles     2 hours 45 minu…\n## 11 Back again     3 Mount Rushmore, South Dakota     (-103 43.9)         (-93.4 43.6) Albert Lea, Minnesota        src       dst                 548.           866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...           538. 540 miles     9 hours 15 minu…\n## 12 Back again     4 Albert Lea, Minnesota           (-93.4 43.6)         (-91.4 40.6) Nauvoo, Illinois             src       dst                 359.           487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...           303. 300 miles     6 hours 0 minut…\n## 13 Back again     5 Nauvoo, Illinois                (-91.4 40.6)         (-84.4 33.7) Atlanta, Georgia             src       dst                 847.          1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...           745. 750 miles     14 hours 0 minu…\n```\n:::\n\n\nLet's see how this looks! Because we set the default geometry of `routes_geocoded` to the route, `geom_sf(data = routes_geocoded)` will automatically plot the `LINESTRING` geometries for the routes as paths:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48) +\n  geom_sf(data = routes_geocoded, color = clrs[1]) +\n  geom_sf(data = all_stops_unique) +\n  geom_label_repel(\n    data = all_stops_unique,\n    aes(label = city, geometry = geometry),\n    stat = \"sf_coordinates\", seed = 1234,\n    size = 3, segment.color = clrs[3], min.segment.length = 0\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Automatically geocoded routes between all our road trip stops](index_files/figure-html/plot-routes-stops-1.png){fig-align='center' fig-alt='Automatically geocoded routes between all our road trip stops' width=100%}\n:::\n:::\n\n\nAHH that's so cool! It works!\n\nWe're not done yet though—let's make this even fancier!\n\n\n# States crossed through\n\nWe're going to be driving through a lot of states. Let's highlight each of the states we'll cross through to see how many there are. To do this we can use `st_intersection()` to find which of the `lower_48` states contain a part of the different routes. We'll then make a copy of `lower_48` with a new column indicating if we'll visit the state:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstates_crossed_through <- st_intersection(\n  st_transform(lower_48, st_crs(routes_geocoded)),\n  routes_geocoded\n)\n\n# There are 32 rows here, but 18 unique states (i.e. one day will end in a state\n# and start the next day in the same state, so it gets counted twice)\nstates_crossed_through %>% \n  select(STATEFP, NAME, direction, day)\n## Simple feature collection with 32 features and 4 fields\n## Geometry type: GEOMETRY\n## Dimension:     XY\n## Bounding box:  xmin: -113 ymin: 29.4 xmax: -84.4 ymax: 44.9\n## Geodetic CRS:  WGS 84\n## First 10 features:\n##      STATEFP        NAME direction day                       geometry\n## 4         13     Georgia     There   1 LINESTRING (-84.4 33.7, -84...\n## 10        22   Louisiana     There   1 LINESTRING (-89.6 30.3, -89...\n## 32        28 Mississippi     There   1 LINESTRING (-88.4 30.5, -88...\n## 41        01     Alabama     There   1 LINESTRING (-85.2 32.9, -85...\n## 1         48       Texas     There   2 LINESTRING (-93.7 30.1, -93...\n## 10.1      22   Louisiana     There   2 LINESTRING (-90.1 30, -90.3...\n## 1.1       48       Texas     There   3 LINESTRING (-98.5 29.4, -98...\n## 36        35  New Mexico     There   3 LINESTRING (-104 32, -104 3...\n## 36.1      35  New Mexico     There   4 LINESTRING (-104 32.4, -104...\n## 47        04     Arizona     There   4 LINESTRING (-109 35.4, -109...\nunique(states_crossed_through$NAME)\n##  [1] \"Georgia\"      \"Louisiana\"    \"Mississippi\"  \"Alabama\"      \"Texas\"        \"New Mexico\"   \"Arizona\"      \"Utah\"         \"Idaho\"        \"Montana\"      \"Wyoming\"      \"South Dakota\" \"Minnesota\"    \"Illinois\"     \"Iowa\"         \"Kentucky\"     \"Missouri\"     \"Tennessee\"\n\n# Create a column that flags if the state is cross through\nlower_48_highlighted <- lower_48 %>% \n  mutate(visited = NAME %in% unique(states_crossed_through$NAME))\n```\n:::\n\n\nNow we can fill using the `visited` column and make the visited states subtly darker:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48_highlighted, aes(fill = visited)) +\n  geom_sf(data = routes_geocoded, color = clrs[1]) +\n  geom_sf(data = all_stops_unique) +\n  geom_label_repel(\n    data = all_stops_unique,\n    aes(label = city, geometry = geometry),\n    stat = \"sf_coordinates\", seed = 1234,\n    size = 3, segment.color = clrs[3], min.segment.length = 0\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Map of road trip route with crossed-through states highlighted](index_files/figure-html/plot-routes-stops-highlighted-1.png){fig-align='center' fig-alt='Map of road trip route with crossed-through states highlighted' width=100%}\n:::\n:::\n\n\n\n# Summary statistics\n\nNow that we have a list of the states we'll cross through, let's play with some quick summary statistics.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nn_states <- length(unique(states_crossed_through$NAME))\nn_states\n## [1] 18\n\ntotal_distance <- sum(routes_geocoded$route_distance) %>% km_to_miles() %>% fmt_miles()\ntotal_distance\n## [1] \"5,260 miles\"\n\ntotal_time <- sum(routes_geocoded$route_duration) %>% fmt_duration()\ntotal_time\n## [1] \"99 hours 15 minutes\"\n```\n:::\n\n\n**We're going to drive through 18 states, with a total distance of 5,260 miles over the span of 99 hours 15 minutes (!!)**\n\nWe can use these distance or duration columns to add some extra detail to the map:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48_highlighted, aes(fill = visited)) +\n  geom_sf(data = routes_geocoded, color = clrs[1]) +\n  geom_sf(data = all_stops_unique) +\n  geom_label_repel(\n    data = routes_geocoded,\n    aes(label = distance_text, geometry = route_geometry),\n    stat = \"sf_coordinates\", seed = 12345,\n    size = 3, segment.color = clrs[3], min.segment.length = 0,\n    fill = colorspace::lighten(clrs[5], 0.8)\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  labs(title = glue(\"{n_states} states; {total_distance}; and {total_time} in the car. Bring it on.\")) +\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Map of road trip showing the distances between each stop](index_files/figure-html/plot-routes-stops-distances-1.png){fig-align='center' fig-alt='Map of road trip showing the distances between each stop' width=100%}\n:::\n:::\n\n\n\n# Faceting\n\nWe have some nice tidy data here with columns for direction and day, which makes it easy to subset the data. We can make separate maps for the drive there and the drive back, or even separate maps for each day of the trip. Let's add `facet_wrap()` to the plot:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48_highlighted, aes(fill = visited)) +\n  geom_sf(data = routes_geocoded, color = clrs[1]) +\n  geom_sf(data = all_stops_unique) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip() +\n  facet_wrap(vars(direction), ncol = 1)\n```\n\n::: {.cell-output-display}\n![Road trip map faceted by direction](index_files/figure-html/plot-facet-subset-issues-1.png){fig-align='center' fig-alt='Road trip map faceted by direction' width=100%}\n:::\n:::\n\n\nThere are two problems with this though:\n\n1. The highlighted states are the same in both facets\n2. The final destination point is missing in each facet (Spanish Fork, Utah in the \"There\" facet; Atlanta, Georgia in the \"Back Again\" facet)\n\nBoth of these issues are fixable though.\n\n## Fixing state highlighting\n\nFirst we need to change how we identify the states we'll cross through. Before, we kept the unique state names, but this stripped away the details about the direction of the trip, so we'll find all the distinct combinations of direction and state and then join that little dataset to `lower_48` to make the `visited` column:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstates_crossed_through_better <- st_intersection(\n  st_transform(lower_48, st_crs(routes_geocoded)),\n  routes_geocoded\n) %>% \n  distinct(direction, NAME)\nstates_crossed_through_better\n##       direction         NAME\n## 4         There      Georgia\n## 10        There    Louisiana\n## 32        There  Mississippi\n## 41        There      Alabama\n## 1         There        Texas\n## 36        There   New Mexico\n## 47        There      Arizona\n## 35        There         Utah\n## 12   Back again        Idaho\n## 35.2 Back again         Utah\n## 15   Back again      Montana\n## 25   Back again      Wyoming\n## 23   Back again South Dakota\n## 16   Back again    Minnesota\n## 14   Back again     Illinois\n## 18   Back again         Iowa\n## 3    Back again     Kentucky\n## 4.1  Back again      Georgia\n## 7    Back again     Missouri\n## 9    Back again    Tennessee\n\nlower_48_highlighted_better <- lower_48 %>% \n  left_join(states_crossed_through_better, by = join_by(NAME)) %>% \n  mutate(visited = !is.na(direction))\nas_tibble(lower_48_highlighted_better)\n## # A tibble: 51 × 12\n##    STATEFP STATENS  AFFGEOID    GEOID STUSPS NAME       LSAD         ALAND      AWATER direction                                                                                 geometry visited\n##    <chr>   <chr>    <chr>       <chr> <chr>  <chr>      <chr>        <dbl>       <dbl> <fct>                                                                           <MULTIPOLYGON [°]> <lgl>  \n##  1 48      01779801 0400000US48 48    TX     Texas      00    676685555821 18974391187 There      (((-107 31.9, -107 32, -107 32, -107 32, -106 32, -106 32, -106 32, -106 32, -105 32... TRUE   \n##  2 06      01779778 0400000US06 06    CA     California 00    403673617862 20291712025 <NA>       (((-119 33.5, -118 33.5, -118 33.4, -118 33.4, -118 33.3, -118 33.3, -118 33.3, -118... FALSE  \n##  3 21      01779786 0400000US21 21    KY     Kentucky   00    102266581101  2384240769 Back again (((-89.5 36.6, -89.5 36.6, -89.4 36.6, -89.4 36.6, -89.3 36.6, -89.3 36.6, -89.3 36.... TRUE   \n##  4 13      01705317 0400000US13 13    GA     Georgia    00    149486268417  4418716153 There      (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3... TRUE   \n##  5 13      01705317 0400000US13 13    GA     Georgia    00    149486268417  4418716153 Back again (((-85.6 35, -85.5 35, -85.4 35, -85.4 35, -85.3 35, -85.3 35, -85 35, -85 35, -85 3... TRUE   \n##  6 55      01779806 0400000US55 55    WI     Wisconsin  00    140292518676 29343193162 <NA>       (((-86.9 45.4, -86.8 45.5, -86.8 45.4, -86.9 45.4, -86.9 45.3, -87 45.4, -86.9 45.4)... FALSE  \n##  7 41      01155107 0400000US41 41    OR     Oregon     00    248630319014  6169061220 <NA>       (((-125 42.8, -124 43, -124 43, -124 43.1, -124 43.2, -124 43.2, -124 43.3, -124 43.... FALSE  \n##  8 29      01779791 0400000US29 29    MO     Missouri   00    178052253239  2487526202 Back again (((-95.8 40.6, -95.5 40.6, -95.4 40.6, -95.3 40.6, -95.2 40.6, -95.1 40.6, -94.9 40.... TRUE   \n##  9 51      01779803 0400000US51 51    VA     Virginia   00    102258178227  8528072639 <NA>       (((-76 37.3, -76 37.4, -76 37.4, -75.9 37.5, -75.9 37.6, -75.9 37.6, -75.9 37.7, -75... FALSE  \n## 10 47      01325873 0400000US47 47    TN     Tennessee  00    106792368794  2322190840 Back again (((-90.3 35, -90.3 35, -90.2 35.1, -90.2 35.1, -90.2 35.1, -90.1 35.1, -90.1 35.2, -... TRUE   \n## # ℹ 41 more rows\n```\n:::\n\n\nLet's see how it works by adding a new `geom_sf()` layer for the highlighted states. We need to double up here with both `lower_48` and `lower_48_highlighted_better` because if we only plot the highlighted states, each facet will only contain those states and not the underlying US map, which we don't want.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48) +\n  geom_sf(data = na.omit(lower_48_highlighted_better), aes(fill = visited)) +\n  geom_sf(data = routes_geocoded, color = clrs[1]) +\n  geom_sf(data = all_stops_unique) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  scale_fill_manual(values = c(\"grey80\"), guide = \"none\") +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip() +\n  facet_wrap(vars(direction), ncol = 1)\n```\n\n::: {.cell-output-display}\n![Each facet now only shows the states corresponding to each direction](index_files/figure-html/plot-facet-subset-issues-fixed1-1.png){fig-align='center' fig-alt='Each facet now only shows the states corresponding to each direction' width=100%}\n:::\n:::\n\n\nThere, we fixed issue #1. ✅\n\nIssue #2—the missing endpoint in each facet—is a little trickier to deal with, but still doable. Before messing with the real data, let's look at a simpler toy example first. Here's a little dataset with three different \"routes\" between cities. The coordinates here aren't actually coordinates—they're just some arbitrary numbers. But that's okay—this basically mirrors what we have in `routes_geocoded`\n\n## Fixing missing destination cities\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nexample <- tribble(\n  ~day, ~origin_city, ~destination_city, ~origin_coords, ~destination_coords,\n  1,    \"Atlanta\",    \"Boston\",          1234,           5678,\n  2,    \"Boston\",     \"Chicago\",         5678,           91011,\n  3,    \"Chicago\",    \"Denver\",          91011,          131415\n) \nexample\n## # A tibble: 3 × 5\n##     day origin_city destination_city origin_coords destination_coords\n##   <dbl> <chr>       <chr>                    <dbl>              <dbl>\n## 1     1 Atlanta     Boston                    1234               5678\n## 2     2 Boston      Chicago                   5678              91011\n## 3     3 Chicago     Denver                   91011             131415\n```\n:::\n\n\nThe reason we're not getting the final point in each facet or subset is because there are only three rows here, but four cities. If we plotted the `origin_coords` column, Atlanta would be missing; if we plotted the `destination_coords` column, Denver would be missing. We need to manipulate this data so that it has 4 rows (Atlanta, Boston, Chicago, Denver), with the correct coordinates for each city. \n\nThere's an easy way to do this with `pivot_longer()` from {tidyr}. We can pivot with multiple columns that follow a pattern in their names. Here, all four of the columns we care about are are prefixed `destination` or `origin`, followed by a `_`. If we specify these name settings in `pivot_longer()`, it'll automatically create a column named `type` for destination and origin and it'll put the rest of the data in corresponding columns:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nexample %>% \n  pivot_longer(\n    cols = c(origin_city, destination_city, origin_coords, destination_coords),\n    names_to = c(\"type\", \".value\"),\n    names_sep = \"_\"\n  )\n## # A tibble: 6 × 4\n##     day type        city    coords\n##   <dbl> <chr>       <chr>    <dbl>\n## 1     1 origin      Atlanta   1234\n## 2     1 destination Boston    5678\n## 3     2 origin      Boston    5678\n## 4     2 destination Chicago  91011\n## 5     3 origin      Chicago  91011\n## 6     3 destination Denver  131415\n```\n:::\n\n\nNow we have one row per city, which is close to what we need. Boston and Chicago are duplicated (since they're both destination and origin cities), so we need to filter out duplicate cities. There are lots of ways to do this—my preferred way is to group by city and keep the first row in each group using `slice()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nexample %>% \n  pivot_longer(\n    cols = c(origin_city, destination_city, origin_coords, destination_coords),\n    names_to = c(\"type\", \".value\"),\n    names_sep = \"_\"\n  ) %>% \n  group_by(city) %>% \n  slice(1)\n## # A tibble: 4 × 4\n## # Groups:   city [4]\n##     day type        city    coords\n##   <dbl> <chr>       <chr>    <dbl>\n## 1     1 origin      Atlanta   1234\n## 2     1 destination Boston    5678\n## 3     2 destination Chicago  91011\n## 4     3 destination Denver  131415\n```\n:::\n\n\nWoohoo! A dataset with four rows and the correct coordinates for each city. If we could plot this, we'd get both endpoints (Atlanta and Denver).\n\nThis same double pivot approach (magically!!) works with the special geometry columns in our actual routes data:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nall_stops_endpoints <- routes_geocoded %>% \n  pivot_longer(\n    cols = c(origin_city, destination_city, origin_geometry, destination_geometry),\n    names_to = c(\"type\", \".value\"),\n    names_sep = \"_\"\n  ) %>% \n  group_by(direction, city) %>% \n  slice(1) %>% \n  arrange(direction, day, desc(type)) %>% \n  # Use \"geometry\" as the default geometry column instead of the routes\n  st_set_geometry(\"geometry\")\n\nall_stops_endpoints\n## Simple feature collection with 15 features and 11 fields\n## Active geometry column: geometry\n## Geometry type: POINT\n## Dimension:     XY\n## Bounding box:  xmin: -112 ymin: 29.4 xmax: -84.4 ymax: 44.6\n## Geodetic CRS:  WGS 84\n## # A tibble: 15 × 13\n## # Groups:   direction, city [15]\n##    direction    day route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text       type        city                             geometry\n##    <fct>      <dbl> <chr>     <chr>              <dbl>          <dbl>                                                                          <LINESTRING [°]>          <dbl> <chr>         <chr>               <chr>       <chr>                         <POINT [°]>\n##  1 There          1 src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes  origin      Atlanta, Georgia             (-84.4 33.7)\n##  2 There          1 src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes  destination New Orleans, Louisiana         (-90.1 30)\n##  3 There          2 src       dst                 596.           870. (-90.1 30, -90.3 30, -90.5 30.1, -90.9 30.2, -91.1 30.4, -91.3 30.5, -92.1 30.2, -93.2...           541. 540 miles     10 hours 0 minutes  destination San Antonio, Texas           (-98.5 29.4)\n##  4 There          3 src       dst                 458.           727. (-98.5 29.4, -98.7 29.7, -98.9 30, -99.5 30.3, -99.8 30.5, -99.9 30.5, -100 30.4, -101...           452. 450 miles     7 hours 45 minutes  destination Carlsbad, New Mexico          (-104 32.4)\n##  5 There          4 src       dst                 749.          1100. (-104 32.4, -104 32.5, -104 32.6, -104 32.9, -104 32.9, -104 33.3, -105 33.4, -105 33....           684. 680 miles     12 hours 30 minutes destination Grand Canyon NP, Arizona      (-112 36.1)\n##  6 There          5 src       dst                 510.           628. (-112 36.1, -112 36, -112 36, -112 36, -112 36, -112 35.9, -112 35.9, -112 35.9, -111 ...           390. 390 miles     8 hours 30 minutes  destination Grover, Utah                  (-111 38.2)\n##  7 There          6 src       dst                 197.           273. (-111 38.2, -111 38.2, -111 38.3, -112 38.3, -112 38.4, -112 38.4, -112 38.4, -112 38....           169. 170 miles     3 hours 15 minutes  destination Spanish Fork, Utah            (-112 40.1)\n##  8 Back again     1 src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes  origin      Spanish Fork, Utah            (-112 40.1)\n##  9 Back again     1 src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes  destination Shelley, Idaho                (-112 43.4)\n## 10 Back again     1 src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minutes  destination Yellowstone NP, Wyoming       (-111 44.5)\n## 11 Back again     2 src       dst                 552.           694. (-111 44.5, -111 44.4, -111 44.5, -111 44.5, -110 44.5, -110 44.6, -110 44.5, -110 44....           431. 430 miles     9 hours 15 minutes  destination Devil's Tower, Wyoming        (-105 44.6)\n## 12 Back again     2 src       dst                 161.           215. (-105 44.6, -105 44.6, -105 44.6, -105 44.6, -105 44.5, -105 44.5, -105 44.5, -105 44....           133. 130 miles     2 hours 45 minutes  destination Mount Rushmore, South Dakota  (-103 43.9)\n## 13 Back again     3 src       dst                 548.           866. (-103 43.9, -103 43.9, -103 44, -103 44, -103 44.1, -103 44.1, -103 44.1, -102 44.1, -...           538. 540 miles     9 hours 15 minutes  destination Albert Lea, Minnesota        (-93.4 43.6)\n## 14 Back again     4 src       dst                 359.           487. (-93.4 43.6, -93.3 43.1, -92.7 43.1, -92.7 43, -92.7 43, -92.6 43, -92.5 42.7, -92.5 4...           303. 300 miles     6 hours 0 minutes   destination Nauvoo, Illinois             (-91.4 40.6)\n## 15 Back again     5 src       dst                 847.          1199. (-91.4 40.6, -91.4 40.4, -91.6 40.4, -91.5 39.7, -91.4 39.7, -91.4 39.6, -91 39.2, -90...           745. 750 miles     14 hours 0 minutes  destination Atlanta, Georgia             (-84.4 33.7)\n```\n:::\n\n\nAnd plotted:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48) +\n  geom_sf(data = na.omit(lower_48_highlighted_better), aes(fill = visited)) +\n  geom_sf(data = routes_geocoded, color = clrs[1]) +\n  geom_sf(data = all_stops_endpoints) +\n  geom_label_repel(\n    data = all_stops_endpoints,\n    aes(label = city, geometry = geometry),\n    stat = \"sf_coordinates\", seed = 1234,\n    size = 3, segment.color = clrs[3], min.segment.length = 0\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  scale_fill_manual(values = c(\"grey80\"), guide = \"none\") +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip() +\n  facet_wrap(vars(direction), ncol = 1)\n```\n\n::: {.cell-output-display}\n![Each facet now shows the destination city](index_files/figure-html/plot-facet-subset-issues-fixed2-1.png){fig-align='center' fig-alt='Each facet now shows the destination city' width=100%}\n:::\n:::\n\n\nIssue #2 fixed. ✅\n\n\n# Zooming in\n\nWe can also make separate maps that are zoomed in on each day of the trip in addition these bigger overarching ones. This will allow us to add more details like driving time and distances without getting too crowded on the map.\n\nWe'll create a mini map of the first day by itself, and then scale up the process to make all the mini maps programmatically. \n\n## One day of the trip\n\nFirst we'll extract the route, cities, and states for the first day of the trip out there:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nroute_day1 <- routes_geocoded %>% \n  filter(direction == \"There\", day == 1)\n\nstops_day1 <- all_stops_endpoints %>% \n  filter(direction == \"There\", day == 1)\n\nstates_crossed_day1 <- st_intersection(\n  st_transform(lower_48, st_crs(route_day1)),\n  route_day1\n) %>% \n  distinct(NAME)\n\nlower_48_highlighted_day1 <- lower_48 %>% \n  mutate(visited = NAME %in% states_crossed_day1$NAME)\n```\n:::\n\n\nLet's plot these to make sure it worked:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +\n  geom_sf(data = route_day1, color = clrs[1]) +\n  geom_sf(data = stops_day1) +\n  geom_sf_label(\n    data = stops_day1, \n    aes(label = city),\n    nudge_y = miles_to_meters(80)\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(crs = st_crs(\"ESRI:102003\")) +  # Albers\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Drive for the first day on the full US map](index_files/figure-html/plot-day1-preliminary-1.png){fig-align='center' fig-alt='Drive for the first day on the full US map' width=100%}\n:::\n:::\n\n\nYep, it worked. But we don't need to show the whole map—we want to zoom in on just the area around the route for the day. To do this, we can use `st_bbox()` to extract a rectangle of coordinates around the route, creating a bounding box for the map that we can then use with `coord_sf()` to zoom in.\n\n`st_bbox()` returns a named vector of numbers with the x- and y-axis limits:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbox <- st_bbox(route_day1)\nbbox\n##  xmin  ymin  xmax  ymax \n## -90.1  30.0 -84.4  33.7\n```\n:::\n\n\nSince the elements are all named, we can use them to specify the different values in `coord_sf()`. First we'll temporarily stop using the [Albers projection](https://en.wikipedia.org/wiki/Albers_projection), since the numbers we've extracted with `st_bbox()` are on the [WGS 84 (−180 to 180) scale](https://en.wikipedia.org/wiki/World_Geodetic_System) and Albers uses meters, which will make the map not work. (But we'll fix that in a minute!)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +\n  geom_sf(data = route_day1, color = clrs[1]) +\n  geom_sf(data = stops_day1) +\n  geom_sf_label(\n    data = stops_day1, \n    aes(label = city),\n    # We're not using Albers, so this isn't measured in meters; it's decimal degrees\n    nudge_y = 0.15\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\"\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(\n    xlim = c(bbox[\"xmin\"], bbox[\"xmax\"]), \n    ylim = c(bbox[\"ymin\"], bbox[\"ymax\"])\n  ) +\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Trip for the first day, but zoomed in a little too far](index_files/figure-html/plot-day1-bbox-basic-1.png){fig-align='center' fig-alt='Trip for the first day, but zoomed in a little too far' width=100%}\n:::\n:::\n\n\nWe're zoomed in (yay) but the edges of the bounding box window are too close to the points and the route, and the labels are cropped funny. Also, to shift the labels up we had to think in [decimal degrees](https://en.wikipedia.org/wiki/Decimal_degrees) instead of meters, which I can't do naturally. And also, we can't change projections—because we're specifying the bounding box coordinates in decimal degrees, we're stuck with WGS 84 instead of Albers or any other projection. These are all fixable issues, fortunately.\n\nTo fix all this, we'll expand the bounding box window by 150 miles on all sides using `st_buffer()` and then convert the coordinates to Albers before extracting the coordinates of the window for plotting:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbox_nice <- route_day1 %>% \n  st_bbox() %>%  # Extract the bounding box of the coordinates\n  st_as_sfc() %>%  # Convert the bounding box matrix back to an sf object\n  st_buffer(miles_to_meters(150)) %>%  # Add 150 miles to all sides\n  st_transform(\"ESRI:102003\") %>%  # Switch to Albers\n  st_bbox()  # Extract the bounding box of the expanded box\nbbox_nice\n##     xmin     ymin     xmax     ymax \n##   301851 -1071395  1366321  -105313\n```\n:::\n\n\nThese are no longer in decimal degrees, so we can use them with the Albers projection. We've also added a 150-mile buffer around the window, so we should have room for all the labels now. Let's check it:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +\n  geom_sf(data = route_day1, color = clrs[1]) +\n  geom_sf(data = stops_day1) +\n  geom_sf_label(\n    data = stops_day1, \n    aes(label = city),\n    # We're in Albers again, so we can work with meters (or miles)\n    nudge_y = miles_to_meters(30)\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\",\n    width_hint = 0.4\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(\n    xlim = c(bbox_nice[\"xmin\"], bbox_nice[\"xmax\"]), \n    ylim = c(bbox_nice[\"ymin\"], bbox_nice[\"ymax\"]),\n    crs = st_crs(\"ESRI:102003\")\n  ) +\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Trip for the first day, correctly zoomed and using the Albers projection](index_files/figure-html/plot-day1-bbox-buffer-albers-1.png){fig-align='center' fig-alt='Trip for the first day, correctly zoomed and using the Albers projection' width=100%}\n:::\n:::\n\n\nHeck yeah.\n\nHowever, the shapes look a little curved and distorted because we're zoomed in so much. Albers is great for big countries, but on a small scale like this, WGS 84 is probably fine. That's what Google Maps does—it only starts getting weird and curvy along horizontal latitude lines when you zoom out really far. Let's do the first day map one last time without the Albers conversion:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbbox_nice <- route_day1 %>% \n  st_bbox() %>%  # Extract the bounding box of the coordinates\n  st_as_sfc() %>%  # Convert the bounding box matrix back to an sf object\n  st_buffer(miles_to_meters(150)) %>%  # Add 150 miles to all sides\n  st_bbox()  # Extract the bounding box of the expanded box\n\nggplot() +\n  geom_sf(data = lower_48_highlighted_day1, aes(fill = visited)) +\n  geom_sf(data = route_day1, color = clrs[1]) +\n  geom_sf(data = stops_day1) +\n  geom_sf_label(\n    data = stops_day1, \n    aes(label = city),\n    # We're in WGS 84, so these are decimal degrees\n    nudge_y = 0.5\n  ) +\n  geom_label_repel(\n    data = route_day1,\n    aes(label = distance_text, geometry = route_geometry),\n    stat = \"sf_coordinates\", seed = 12345,\n    family = \"Overpass ExtraBold\", fontface = \"plain\",\n    size = 3.5, fill = colorspace::lighten(clrs[5], 0.8), color = clrs[1], \n    segment.color = \"grey50\", min.segment.length = 0\n  ) +\n  annotation_scale(\n    location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n    unit_category = \"imperial\", text_family = \"Overpass\",\n    width_hint = 0.3\n  ) +\n  scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n  coord_sf(\n    xlim = c(bbox_nice[\"xmin\"], bbox_nice[\"xmax\"]), \n    ylim = c(bbox_nice[\"ymin\"], bbox_nice[\"ymax\"]),\n    crs = st_crs(\"EPSG:4326\")\n  ) +\n  theme_roadtrip()\n```\n\n::: {.cell-output-display}\n![Trip for the first day, correctly zoomed and using the WGS 84 projection](index_files/figure-html/plot-day1-bbox-buffer-wgs84-1.png){fig-align='center' fig-alt='Trip for the first day, correctly zoomed and using the WGS 84 projection' width=100%}\n:::\n:::\n\n\nNeat. The northern borders of Georgia, Alabama, and Mississippi are all flat here, which is great.\n\n## All the days of the trip\n\nWe successfully plotted one day of the trip. But we'll be driving for 11 days (!) and need 11 plots. I don't want to copy/paste this all code 11 times, so we'll stick each major step into a function:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Take a set of routes and do some pivoting to create a dataset that includes\n# the start and end points\nexpand_endpoints <- function(routes) {\n  routes %>% \n    pivot_longer(\n    cols = c(origin_city, destination_city, origin_geometry, destination_geometry),\n    names_to = c(\"type\", \".value\"),\n    names_sep = \"_\"\n  ) %>% \n  group_by(city) %>% \n  slice(1) %>% \n  arrange(desc(type)) %>% \n  st_set_geometry(\"geometry\")\n}\n\n# Take a set of routes and return a dataset with a flag marking which states they cross\nfind_states <- function(routes) {\n  # st_intersection() complains about innocuous things so suppress the warnings\n  suppressWarnings({\n    states_crossed <- st_intersection(\n      st_transform(lower_48, st_crs(routes)),\n      routes\n    ) %>% \n      distinct(NAME)\n  })\n  \n  lower_48 %>% \n    mutate(visited = NAME %in% states_crossed$NAME)\n}\n\n# Use routes, stopes, and states to build a plot\nbuild_day_map <- function(routes, stops, states, direction, day) {\n  bbox_nice <- routes %>%\n    st_bbox() %>%  # Extract the bounding box of the coordinates\n    st_as_sfc() %>%  # Convert the bounding box matrix back to an sf object\n    st_buffer(miles_to_meters(150)) %>%  # Add 150 miles to all sides\n    st_bbox()  # Extract the bounding box of the expanded box\n\n  ggplot() +\n    geom_sf(data = states, aes(fill = visited)) +\n    geom_sf(data = routes, color = clrs[1]) +\n    geom_sf(data = stops) +\n    geom_sf_label(\n      data = stops,\n      aes(label = city),\n      # We're in WGS 84, so these are decimal degrees\n      nudge_y = 0.4\n    ) +\n    geom_label_repel(\n      data = routes,\n      aes(label = distance_text, geometry = route_geometry),\n      stat = \"sf_coordinates\", seed = 12345,\n      family = \"Overpass ExtraBold\", fontface = \"plain\",\n      size = 3.5, fill = colorspace::lighten(clrs[5], 0.8), color = clrs[1], \n      segment.color = \"grey50\", min.segment.length = 0\n    ) +\n    annotation_scale(\n      location = \"bl\", bar_cols = c(\"grey30\", \"white\"),\n      unit_category = \"imperial\", text_family = \"Overpass\",\n      width_hint = 0.4\n    ) +\n    scale_fill_manual(values = c(\"grey90\", \"grey80\"), guide = \"none\") +\n    coord_sf(\n      xlim = c(bbox_nice[\"xmin\"], bbox_nice[\"xmax\"]),\n      ylim = c(bbox_nice[\"ymin\"], bbox_nice[\"ymax\"]),\n      crs = st_crs(\"EPSG:4326\")\n    ) +\n    labs(title = glue(\"{direction}, day {day}\")) +\n    theme_roadtrip()\n}\n```\n:::\n\n\nWith everything functionalized, we can do some super wild {purrr} magic. If we take `routes_geocoded` and group it by direction and day (so there's a group per driving day), we'll get a list column that contains the geocded coordinates for each day:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots <- routes_geocoded %>% \n  group_by(direction, day) %>% \n  nest(.key = \"routes\")\n\ndaily_plots\n## # A tibble: 11 × 3\n## # Groups:   direction, day [11]\n##    direction    day routes       \n##    <fct>      <dbl> <list>       \n##  1 There          1 <sf [1 × 12]>\n##  2 There          2 <sf [1 × 12]>\n##  3 There          3 <sf [1 × 12]>\n##  4 There          4 <sf [1 × 12]>\n##  5 There          5 <sf [1 × 12]>\n##  6 There          6 <sf [1 × 12]>\n##  7 Back again     1 <sf [2 × 12]>\n##  8 Back again     2 <sf [2 × 12]>\n##  9 Back again     3 <sf [1 × 12]>\n## 10 Back again     4 <sf [1 × 12]>\n## 11 Back again     5 <sf [1 × 12]>\n\n# Check the first day\ndaily_plots$routes[[1]]\n## Simple feature collection with 1 feature and 9 fields\n## Active geometry column: route_geometry\n## Geometry type: LINESTRING\n## Dimension:     XY\n## Bounding box:  xmin: -90.1 ymin: 30 xmax: -84.4 ymax: 33.7\n## Geodetic CRS:  WGS 84\n## # A tibble: 1 × 12\n##   origin_city      origin_geometry destination_geometry destination_city       route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text     \n##   <chr>                <POINT [°]>          <POINT [°]> <chr>                  <chr>     <chr>              <dbl>          <dbl>                                                                          <LINESTRING [°]>          <dbl> <chr>         <chr>             \n## 1 Atlanta, Georgia    (-84.4 33.7)           (-90.1 30) New Orleans, Louisiana src       dst                 513.           753. (-84.4 33.7, -84.5 33.6, -84.8 33.4, -84.9 33.1, -85.1 32.9, -85.4 32.6, -85.7 32.5, -...           468. 470 miles     8 hours 30 minutes\n\n# Check the first day of the return trip\ndaily_plots$routes[[7]]\n## Simple feature collection with 2 features and 9 fields\n## Active geometry column: route_geometry\n## Geometry type: LINESTRING\n## Dimension:     XY\n## Bounding box:  xmin: -112 ymin: 40.1 xmax: -111 ymax: 44.7\n## Geodetic CRS:  WGS 84\n## # A tibble: 2 × 12\n##   origin_city        origin_geometry destination_geometry destination_city        route_src route_dst route_duration route_distance                                                                            route_geometry distance_miles distance_text duration_text     \n##   <chr>                  <POINT [°]>          <POINT [°]> <chr>                   <chr>     <chr>              <dbl>          <dbl>                                                                          <LINESTRING [°]>          <dbl> <chr>         <chr>             \n## 1 Spanish Fork, Utah     (-112 40.1)          (-112 43.4) Shelley, Idaho          src       dst                 262.           411. (-112 40.1, -112 40.2, -112 40.3, -112 40.5, -112 41, -112 41.1, -112 41.2, -112 41.6,...           256. 260 miles     4 hours 15 minutes\n## 2 Shelley, Idaho         (-112 43.4)          (-111 44.5) Yellowstone NP, Wyoming src       dst                 199.           240. (-112 43.4, -112 43.8, -112 43.9, -112 43.9, -112 44, -112 44, -111 44.1, -111 44.2, -...           149. 150 miles     3 hours 15 minutes\n```\n:::\n\n\nWe can then use `purrr::map()` and `purrr::pmap()` to feed that nested list-column data frame through the different functions to expand endpoints, find crossed-through states, and build the daily plot.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots <- routes_geocoded %>% \n  group_by(direction, day) %>% \n  nest(.key = \"routes\") %>% \n  mutate(\n    stops = map(routes, expand_endpoints),\n    states = map(routes, find_states),\n    plot = pmap(list(routes, stops, states, direction, day), build_day_map)\n  )\n```\n:::\n\n\nBefore looking at the plots, check out all these nested datasets! Each day has a dataset for the routes, stops, states, and final plot, and everything is contained here in a data frame. MAGICAL.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots\n## # A tibble: 11 × 6\n## # Groups:   direction, day [11]\n##    direction    day routes        stops         states         plot  \n##    <fct>      <dbl> <list>        <list>        <list>         <list>\n##  1 There          1 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n##  2 There          2 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n##  3 There          3 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n##  4 There          4 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n##  5 There          5 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n##  6 There          6 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n##  7 Back again     1 <sf [2 × 12]> <sf [3 × 11]> <sf [49 × 11]> <gg>  \n##  8 Back again     2 <sf [2 × 12]> <sf [3 × 11]> <sf [49 × 11]> <gg>  \n##  9 Back again     3 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n## 10 Back again     4 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>  \n## 11 Back again     5 <sf [1 × 12]> <sf [2 × 11]> <sf [49 × 11]> <gg>\n```\n:::\n\n\nWe can extract the plot for any single day with indexing:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[10]]\n```\n\n::: {.cell-output-display}\n![Trip for the day 4 of the return trip](index_files/figure-html/plot-day10-indexed-1.png){fig-align='center' fig-alt='Trip for the day 4 of the return trip' width=100%}\n:::\n:::\n\n\nOr we can filter, pull, and pluck like good denizens of the tidyverse:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots %>% \n  filter(direction == \"Back again\", day == 5) %>% \n  pull(plot) %>% pluck(1)\n```\n\n::: {.cell-output-display}\n![Trip for the day 5 of the return trip](index_files/figure-html/plot-day5-verbose-1.png){fig-align='center' fig-alt='Trip for the day 5 of the return trip' width=100%}\n:::\n:::\n\n\nHere's all of them simultaneously inside a [Quarto tabset](https://quarto.org/docs/output-formats/html-basics.html#tabsets), just for fun:\n\n:::: {.panel-tabset}\n\n## The trip there\n\n::: {.panel-tabset}\n\n### Day 1\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[1]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-there-day1-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 2\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[2]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-there-day2-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 3\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[3]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-there-day3-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 4\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[4]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-there-day4-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 5\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[5]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-there-day5-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 6\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[6]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-there-day6-1.png){fig-align='center' width=100%}\n:::\n:::\n\n:::\n\n## The trip back again\n\n::: {.panel-tabset}\n\n### Day 1\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[7]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-back-day1-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 2\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[8]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-back-day2-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 3\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[9]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-back-day3-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 4\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[10]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-back-day4-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n### Day 5\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots$plot[[11]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/panel-back-day5-1.png){fig-align='center' width=100%}\n:::\n:::\n\n:::\n\n::::\n\nOr, instead of extracting each plot individually like this, we can use `wrap_plots()` from {patchwork} to combine a whole list of plots automatically, though we have a lot less control over the plots this way—some of the maps use a landscape orientation and some use a portrait orientation, so they're a big mess when combined like this:\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\ndaily_plots %>%\n  pull(plot) %>% \n  wrap_plots()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/patchwork-everything-ugly-1.png){fig-align='center' fig-alt='Ugly massive plot of all the days of the trip' width=100%}\n:::\n:::\n\n\n\n---\n\nTime to add some maps to road trip journals and finish packing!\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}